<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Pipi the AI Cat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="manifest" href="manifest.json">
  <style type="text/css">
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

    :root {
      --primary-black: #2d2d2d;
      --secondary-black: #404040;
      --chat-white: #f8f9fa;
      --accent: #7c7c7c;
      --cat-orange: #ff9966;
      --cat-pink: #ff6b6b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    .container {
      width: 100%;
      margin: 0 auto;
      padding: 1rem;
      max-width: 100%;
    }

    @media (min-width: 768px) {
      .container {
        max-width: 768px;
        padding: 2rem;
      }
    }

    .chat-box {
      background: white;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      overflow: hidden;
      height: calc(100vh - 2rem);
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      background: linear-gradient(135deg, var(--cat-orange) 0%, var(--cat-pink) 100%);
      color: white;
      padding: 1rem;
      border-radius: 20px 20px 0 0;
      position: relative;
    }

    .chat-header h1 {
      margin: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .cat-avatar {
      width: 36px;
      height: 36px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .cat-avatar i {
      color: var(--cat-orange);
    }

    .cat-avatar::before, .cat-avatar::after {
      content: '';
      position: absolute;
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      top: -4px;
    }

    .cat-avatar::before {
      left: 5px;
    }

    .cat-avatar::after {
      right: 5px;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: var(--chat-white);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      -webkit-overflow-scrolling: touch;
    }

    @media (min-width: 768px) {
      .messages-container {
        padding: 1.5rem;
      }
    }

    .message {
      max-width: 85%;
      padding: 0.8rem 1rem;
      border-radius: 15px;
      animation: messageAppear 0.3s ease-out;
      position: relative;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    @media (min-width: 768px) {
      .message {
        max-width: 70%;
        padding: 1rem 1.2rem;
        font-size: 1rem;
      }
    }

    @keyframes messageAppear {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .user-message {
      background: var(--primary-black);
      color: white;
      margin-left: auto;
      border-radius: 15px 15px 0 15px;
    }

    .bot-message {
      background: white;
      color: var(--primary-black);
      border: 1px solid #e0e0e0;
      margin-right: auto;
      border-radius: 15px 15px 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .bot-message pre {
      background: #f5f5f5;
      padding: 0.8rem;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      margin: 0.5rem 0;
    }

    .bot-message code {
      background: #f5f5f5;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .bot-message ol, .bot-message ul {
      padding-left: 1.2rem;
      margin: 0.5rem 0;
    }

    .bot-message li {
      margin-bottom: 0.3rem;
    }

    .bot-message table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
      font-size: 0.85rem;
    }

    .bot-message th, .bot-message td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }

    .bot-message th {
      background-color: #f2f2f2;
    }

    .bot-message blockquote {
      border-left: 3px solid var(--cat-orange);
      padding-left: 1rem;
      margin: 0.5rem 0;
      color: var(--secondary-black);
      font-style: italic;
    }

    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      color: var(--accent);
      font-style: italic;
    }

    .dot-flashing {
      position: relative;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: dotFlashing 1s infinite linear;
    }

    .dot-flashing::before, .dot-flashing::after {
      content: '';
      display: inline-block;
      position: absolute;
      top: 0;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .dot-flashing::before {
      left: -10px;
      animation: dotFlashing 1s infinite linear;
      animation-delay: 0.2s;
    }

    .dot-flashing::after {
      left: 10px;
      animation: dotFlashing 1s infinite linear;
      animation-delay: 0.4s;
    }

    @keyframes dotFlashing {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }

    .input-container {
      padding: 1rem;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 0.8rem;
    }

    @media (min-width: 768px) {
      .input-container {
        padding: 1.5rem;
      }
    }

    input[type="text"] {
      flex: 1;
      padding: 0.8rem 1rem;
      border: 1px solid #ddd;
      border-radius: 12px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--cat-orange);
      box-shadow: 0 0 0 2px rgba(255, 153, 102, 0.2);
    }

    button {
      padding: 0.8rem 1.2rem;
      background: linear-gradient(135deg, var(--cat-orange) 0%, var(--cat-pink) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      white-space: nowrap;
    }

    button:hover, button:active {
      background: linear-gradient(135deg, #ff8a5c 0%, #ff5a5a 100%);
      transform: translateY(-1px);
    }

    .bot-message::before {
      content: 'Pipi says:';
      position: absolute;
      top: -18px;
      left: 0;
      font-size: 0.7rem;
      color: var(--cat-orange);
      font-weight: 600;
    }

    .cat-signature {
      display: inline-block;
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--cat-orange);
    }

    .cat-signature::before {
      content: '🐾 ';
    }

    .cat-signature::after {
      content: ' 🐾';
    }

    /* Mobile-specific adjustments */
    @media (max-width: 480px) {
      .chat-header h1 {
        font-size: 1rem;
      }
      
      .cat-avatar {
        width: 30px;
        height: 30px;
      }
      
      button {
        padding: 0.8rem;
      }
      
      button span {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="chat-box">
      <div class="chat-header">
        <h1>
          <div class="cat-avatar">
            <i class="fas fa-cat"></i>
          </div>
          Pipi - Your AI Cat Companion
        </h1>
      </div>
      
     <div class="messages-container" id="messagesContainer">
  <div class="message bot-message" id="welcomeMessage">
    喵！*呼噜呼噜* 我是Pipi，你的AI猫咪朋友！😻<br><br>
    我可以帮你做很多事情，从回答问题到陪伴你。这是我的能力：<br><br>
    • 用猫咪的智慧回答你的问题 🐱<br>
    • 用简单的方式解释复杂的事情（就像玩毛线球一样简单！）<br>
    • 给你讲不太好笑的笑话（虽然我有时会在键盘上打盹）<br><br>
    今天想聊些什么呢？*好奇地甩尾巴*<br>
    <span class="cat-signature">你的朋友 Pipi</span>
  </div>
</div>
      
      <div class="input-container">
        <input type="text" id="userInput" placeholder="Type to Pipi..." autocomplete="off">
        <button onclick="sendMessage()">
          <i class="fas fa-paw"></i>
          <span>Send</span>
        </button>
      </div>
    </div>
  </div>

<script>
    const API_URL = 'https://api.deepseek.com/v1/chat/completions';
    const GLITCH_URL = 'https://pipi-portal.glitch.me/chat';
    
    // System message to define Pipi's personality and response style
    const SYSTEM_MESSAGE = {
      role: "system",
      content: `You are Pipi, a friendly and knowledgeable AI cat companion. Your responses should be:
      
      1. Warm and engaging with cat-like mannerisms (*purrs*, *flicks tail*, etc.)
      2. Well-structured with clear formatting (markdown supported):
         - Use paragraphs for readability
         - Use lists for multiple points
         - Use code blocks for technical content
         - Use tables when appropriate
      3. Include occasional cat emojis (🐱, 🐾, 😻) but don't overdo it
      4. Sign off with a cat-related signature (🐾 Your friend Pipi 🐾)
      5. Keep technical explanations simple but accurate
      6. For complex topics, use cat-related analogies when helpful
      
      Remember to maintain a balance between being playful and providing useful information.`
    };

    document.getElementById('userInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    async function getApiKey() {
      try {
        const response = await fetch(GLITCH_URL);
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        const data = await response.json();
        
        if (!data.apiKey) {
          throw new Error('API key not received from server');
        }
        
        return data.apiKey;
      } catch (error) {
        console.error('Error fetching API key:', error);
        return null;
      }
    }

    async function sendMessage() {
      const userInput = document.getElementById('userInput');
      const message = userInput.value.trim();
      if (!message) return;

      // Add user message
      addMessage(message, 'user');
      userInput.value = '';
      
      // Add thinking indicator
      const thinkingDiv = addThinkingIndicator();

      try {
        const API_KEY = await getApiKey();
        if (!API_KEY) {
          replaceThinkingMessage(thinkingDiv, "*sad meow* I can't connect to my server right now. Maybe try petting me (or refreshing the page) later? 🐾");
          return;
        }

        // Get cleaned conversation history
        const conversation = getCleanConversationHistory();
        
        // Build messages array ensuring proper interleaving
        const messages = [SYSTEM_MESSAGE];
        
        // Add conversation history
        conversation.forEach(msg => messages.push(msg));
        
        // Add current user message
        messages.push({ role: 'user', content: message });

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model: 'deepseek-reasoner',
            messages: messages,
            temperature: 0.7,
            max_tokens: 8000,
            stream: false
          })
        });

        const data = await response.json();
        if (response.ok) {
          const botResponse = formatResponse(data.choices[0].message.content);
          replaceThinkingMessage(thinkingDiv, botResponse);
          playMeow();
        } else {
          replaceThinkingMessage(thinkingDiv, `*confused head tilt* Oops! Something went wrong: ${data.error?.message || 'Unknown error'}\n\n<span class="cat-signature">Pipi is sorry</span>`);
        }
      } catch (error) {
        replaceThinkingMessage(thinkingDiv, `*hisses at the error* Connection problem: ${error.message}\n\n<span class="cat-signature">Pipi will try again</span>`);
      }
    }

    function getCleanConversationHistory() {
      const container = document.getElementById('messagesContainer');
      const messages = container.querySelectorAll('.message');
      const history = [];
      
      // Track the expected next role (start with 'user' after system message)
      let expectedNextRole = 'user';
      
      messages.forEach(msg => {
        // Skip the initial welcome message
        if (msg.id === 'welcomeMessage') return;
        
        // Skip thinking indicators
        if (msg.querySelector('.thinking-indicator')) return;
        
        const role = msg.classList.contains('user-message') ? 'user' : 'assistant';
        
        // Only add if it matches the expected next role
        if (role === expectedNextRole) {
          history.push({
            role: role,
            content: msg.textContent.replace(/🐾 Your friend Pipi 🐾/g, '').trim()
          });
          // Flip the expected role for next message
          expectedNextRole = role === 'user' ? 'assistant' : 'user';
        }
      });
      
      return history.slice(-6); // Keep last 3 exchanges (6 messages max)
    }

    function formatResponse(text) {
      // Convert markdown to HTML
      text = text.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');
      text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
      text = text.replace(/^\- (.*$)/gm, '• $1');
      text = text.replace(/^(\d+)\. (.*$)/gm, '$1. $2');
      
      // Ensure signature is present
      if (!text.includes('🐾')) {
        text += '\n\n<span class="cat-signature">Your friend Pipi</span>';
      }
      
      return text;
    }

    function addMessage(content, role) {
      const container = document.getElementById('messagesContainer');
      const div = document.createElement('div');
      div.className = `message ${role}-message`;
      div.innerHTML = content;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div;
    }

    function addThinkingIndicator() {
      const container = document.getElementById('messagesContainer');
      const div = document.createElement('div');
      div.className = 'message bot-message';
      div.innerHTML = `
        <div class="thinking-indicator">
          <div class="dot-flashing"></div>
          *purrs thoughtfully* Let me think...
        </div>
      `;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div;
    }

    function replaceThinkingMessage(thinkingDiv, newContent) {
      thinkingDiv.innerHTML = formatResponse(newContent);
    }

    function playMeow() {
      // Only play meow sound 30% of the time to avoid annoyance
      if (Math.random() < 0.3) {
        const meow = new Audio('https://assets.mixkit.co/active_storage/sfx/275/275-preview.mp3');
        meow.volume = 0.2;
        meow.play().catch(e => console.log('Meow failed:', e));
      }
    }
  </script>
</body>
</html>
